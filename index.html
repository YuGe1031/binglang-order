<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>浅水湾消费点单系统</title>
  <style>
    /* 基础样式 */
    :root {
      --primary-color: #3776f8;
      --secondary-color: #d5e4ff;
      --accent-color: #46d39d;
      --warning-color: #fd7373;
      --success-color: #15b968;
      --text-dark: #3161b8;
      --text-light: #fff;
      --bg-glass: rgba(255,255,255,0.46);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      margin: 0; padding: 0;
      min-height: 100vh;
      background: url('https://i.postimg.cc/qMvjYK8D/image.png') no-repeat center center fixed;
      background-size: cover;
      font-family: "SF Pro Display", "PingFang SC", "Segoe UI", Arial, sans-serif;
      letter-spacing: 0.03em;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
      color: #333;
      position: relative;
    }
    
    body::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.05);
      z-index: -1;
    }
    
    .header-bar {
      position: fixed; top: 0; right: 0; left: 0; z-index: 1001;
      height: 70px;
      background: rgba(250,250,255,0.75);
      box-shadow: 0 1px 24px 0 rgba(60,100,190,.05);
      display: flex; justify-content: flex-end; align-items: center; gap: 15px;
      padding: 0 38px;
      backdrop-filter: blur(16px);
      border-bottom: 1.5px solid #f2f6fc;
    }
    
    .login-btn, .register-btn, .change-pwd-btn {
      background: rgba(90,144,255,0.85);
      color: #fff; border: none;
      border-radius: 12px; padding: 8px 30px;
      font-size: 15px; font-weight: bold;
      margin-left: 8px; cursor: pointer; box-shadow: 0 2px 8px 0 rgba(45,60,120,0.06);
      transition: background .17s;
    }
    
    .login-btn:hover, .register-btn:hover, .change-pwd-btn:hover { background: #206df5; }
    
    .logout-btn {
      background: rgba(238,238,238,0.93);
      color: #444; border: none;
      border-radius: 12px; padding: 8px 22px;
      font-size: 15px; font-weight: bold;
      margin-left: 10px; cursor: pointer;
      box-shadow: 0 2px 6px 0 rgba(30,50,80,0.06);
      transition: background .18s;
    }
    
    .logout-btn:hover { background: #fff2f2; color: #c00; }
    
    .user-info { color: #444; font-size: 15px; font-weight: bold; margin-right: 10px; }
    
    .container {
      max-width: 1100px;
      margin: 110px auto 36px auto;
      background: var(--bg-glass);
      border-radius: 32px;
      padding: 36px 32px 50px 32px;
      box-shadow: 0 12px 50px 0 rgba(36,84,180,.14), 0 2px 8px 0 rgba(100,120,180,.03);
      backdrop-filter: blur(28px);
      position: relative;
    }
    
    h1 {
      text-align: center; color: var(--primary-color);
      margin-bottom: 40px; font-size: 2.3rem; letter-spacing:0.1em;
      font-weight: 900; text-shadow: 0 1px 6px #ddefff38;
      background: linear-gradient(90deg,#3776f8,#a6c8ff 75%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    
    .login-center {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 30px 0;
    }
    
    .login-center-btn {
      background: rgba(90,144,255,0.85);
      color: #fff; border: none;
      border-radius: 16px; 
      padding: 14px 40px;
      font-size: 18px; font-weight: bold;
      cursor: pointer; 
      box-shadow: 0 4px 12px rgba(45,60,120,0.15);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .login-center-btn:hover {
      background: #206df5;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(45,60,120,0.25);
    }
    
    .login-center-btn i {
      font-size: 20px;
    }
    
    .btn-group {
      display: flex; justify-content: center; gap: 30px;
      margin-bottom: 32px; flex-wrap: wrap;
    }
    
    .main-btn {
      padding: 14px 38px; font-size: 18px; border: none; border-radius: 18px;
      background: linear-gradient(90deg, #7dbafd 10%, #d5e4ff 90%);
      color: #1456b5; font-weight: bold; cursor: pointer; transition: 0.18s;
      box-shadow: 0 4px 28px 0 rgba(110,160,255,.13);
      border: 1.5px solid #b6d5ff;
      position: relative;
      overflow: hidden;
    }
    
    .main-btn:disabled {
      background: #c6d4ec; 
      cursor: not-allowed; 
      color: #aac;
      opacity: 0.7;
    }
    
    .main-btn:hover:enabled {
      background: linear-gradient(90deg, #457bdd 30%, #badcff 100%); 
      color: #0940a0;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(110,160,255,.2);
    }
    
    .tip {
      font-size: 15px; 
      color: #c06; 
      margin-bottom: 4px;
      text-align: center;
      padding: 10px;
      background: rgba(255, 240, 240, 0.7);
      border-radius: 10px;
      max-width: 600px;
      margin: 20px auto;
    }
    
    .user-glassbox {
      background: rgba(255,255,255,0.58);
      border-radius: 22px;
      padding: 30px 38px 10px 38px;
      box-shadow: 0 4px 26px 0 rgba(90,140,230,.06);
      margin-bottom: 28px;
      backdrop-filter: blur(16px);
      border: 1.5px solid #d5e5fc;
      transition: box-shadow .14s;
    }
    
    .user-glassbox ul {
      padding-left: 0;
      list-style: none;
    }
    
    .user-glassbox li {
      background: rgba(240,250,255,0.7);
      margin-bottom: 18px; 
      border-radius: 16px;
      padding: 18px 22px 13px 22px;
      box-shadow: 0 1px 6px 0 rgba(160,170,255,.04);
      position:relative;
      font-size: 1.12em;
      display:flex; 
      flex-wrap:wrap; 
      align-items:center; 
      justify-content:space-between;
      transition: background .16s;
    }
    
    .user-glassbox li:last-child {margin-bottom:6px;}
    
    .li-desc span {font-weight:600;}
    
    .li-time {font-size: 13px; color: #88a;}
    
    .li-status {
      font-size: 15px; font-weight: 700;
      border-radius: 7px; padding: 3px 14px;
      margin-left: 18px;
      white-space: nowrap;
    }
    
    .delivered { 
      background:rgba(72,225,141,0.19); 
      color:#15b968; 
      border:1.2px solid #9cf2cf;
    }
    
    .undelivered, .admin-table .undelivered {
      background:rgba(253,221,124,0.21); 
      color:#fba101; 
      border:1.2px solid #fee2b0;
      animation: blinker 1s linear infinite;
    }
    
    @keyframes blinker {
      50% { opacity: 0.32; }
    }
    
    .settled {
      background: rgba(100, 200, 255, 0.2);
      color: #1a6ea0;
      border: 1.2px solid #a0d0ff;
    }
    
    #adminPanelWrap {margin-top:48px;}
    
    .admin-table {
      width: 100%; 
      border-collapse: collapse;
      background: rgba(255,255,255,0.83);
      margin: 12px 0 26px 0; 
      box-shadow:0 3px 14px #c1d7fa24;
      border-radius: 18px; 
      overflow: hidden; 
      font-size: 1.04em;
      backdrop-filter: blur(8px);
    }
    
    .admin-table th, .admin-table td {
      padding: 15px 8px; 
      text-align: center;
      border-bottom: 1.5px solid #f0f4fc;
    }
    
    .admin-table th {
      background: rgba(216,236,255,0.84);
      font-weight: 900; 
      font-size: 1.04em;
      letter-spacing: 0.04em; 
      color: #3476bb;
      border-bottom: 2.5px solid #bed9f9;
      cursor: pointer;
      user-select: none;
    }
    
    .admin-table tr:last-child td {border-bottom: none;}
    
    .admin-btn {
      margin: 0 2px; 
      padding: 6px 18px; 
      border-radius: 10px; 
      font-size: 14px; 
      border: none; 
      cursor: pointer; 
      font-weight:600;
      transition: all 0.2s;
    }
    
    .deliver-btn {
      background: #fed862; 
      color: #7a4a00;
    }
    
    .deliver-btn:hover {background:#ffe39a;}
    
    .edit-btn {
      background: #58a8e6; 
      color: #fff;
    }
    
    .edit-btn:hover {background: #2481d0;}
    
    .delete-btn {
      background: #fd7373; 
      color: #fff;
    }
    
    .delete-btn:hover {background: #b80000;}
    
    .checkout-btn {
      background: #46d39d; 
      color:#fff; 
      margin-left: 7px;
    }
    
    .checkout-btn:hover {background: #22b876;}
    
    .settle-btn {
      background: #8a6dff;
      color: #fff;
    }
    
    .settle-btn:hover {
      background: #6a4dff;
    }
    
    .confirm-payment-btn {
      background: #ff7043;
      color: #fff;
    }
    
    .confirm-payment-btn:hover {
      background: #f4511e;
    }
    
    .admin-user-list {
      display: flex; 
      flex-wrap: wrap; 
      gap: 18px;
      margin-bottom: 20px;
    }
    
    .admin-user-btn {
      background: rgba(187,223,255,0.46); 
      color: #286fe7; 
      font-weight: bold;
      border: 1.5px solid #bbe1fb;
      border-radius: 12px; 
      padding: 12px 32px; 
      cursor: pointer; 
      font-size:17px;
      box-shadow: 0 2px 8px #e6f4ff23;
      margin-bottom:6px;
      transition: background .13s;
      user-select: none;
    }
    
    .admin-user-btn.active {background:#3a74ff;color:#fff;}
    
    .admin-user-btn:hover {background: #e9f5ff;}
    
    .admin-table td:last-child {min-width:170px;}
    
    .admin-table .undelivered {font-weight:bold;}
    
    .admin-notification {
      position: fixed;
      left:50%;top:70px;transform:translateX(-50%);
      z-index:11111;
      min-width:300px;
      background:rgba(254,219,68,0.92);
      color:#763b00;
      font-weight:900;
      border-radius:12px;
      font-size:20px;
      box-shadow: 0 8px 24px #c5a52c23;
      padding:14px 32px 14px 26px;
      animation: adminpop .7s cubic-bezier(.8,-0.1,.3,1.2);
      display:none;
    }
    
    /* 管理员弹窗样式 */
    .admin-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10000;
      min-width: 320px;
      max-width: 90%;
      background: linear-gradient(135deg, #ffd740 0%, #ffc400 100%);
      border-radius: 18px;
      padding: 24px 32px;
      box-shadow: 0 16px 40px rgba(120, 80, 0, 0.3);
      text-align: center;
      animation: adminpop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      display: none;
      border: 2px solid #ffb300;
    }
    
    .admin-popup-title {
      font-size: 22px;
      font-weight: 800;
      color: #5d2900;
      margin-bottom: 16px;
      text-shadow: 0 1px 2px rgba(255,255,255,0.5);
    }
    
    .admin-popup-content {
      font-size: 18px;
      font-weight: 700;
      color: #7a3c00;
      margin-bottom: 24px;
      line-height: 1.4;
    }
    
    .admin-popup-btn {
      background: #5d2900;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 32px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(93,41,0,0.3);
    }
    
    .admin-popup-btn:hover {
      background: #7a3c00;
      transform: translateY(-2px);
    }
    
    .admin-popup-btn:active {
      transform: translateY(1px);
    }
    
    @keyframes adminpop {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    /* 结账弹窗 */
    .settle-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10000;
      width: 90%;
      max-width: 500px;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      text-align: center;
      display: none;
    }
    
    .settle-header {
      font-size: 24px;
      font-weight: bold;
      color: var(--text-dark);
      margin-bottom: 20px;
    }
    
    .settle-amount {
      font-size: 32px;
      font-weight: 800;
      color: var(--warning-color);
      margin: 15px 0;
    }
    
    .qr-container {
      width: 200px;
      height: 200px;
      margin: 0 auto 20px;
      background: #f8f8f8;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border: 1px solid #eee;
    }
    
    .qr-container img {
      max-width: 100%;
      max-height: 100%;
    }
    
    .settle-instructions {
      background: #f0f8ff;
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      font-size: 15px;
      text-align: left;
    }
    
    .settle-instructions ol {
      padding-left: 20px;
      margin: 10px 0;
    }
    
    .settle-instructions li {
      margin-bottom: 8px;
    }
    
    .confirm-payment-btn {
      background: var(--accent-color);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 40px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin: 15px 0 10px;
      box-shadow: 0 4px 12px rgba(70, 211, 157, 0.3);
    }
    
    .confirm-payment-btn:hover {
      background: #2fad7a;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(70, 211, 157, 0.4);
    }
    
    .settle-footer {
      color: #888;
      font-size: 14px;
      margin-top: 15px;
    }
    
    .close-settle-btn {
      background: none;
      border: none;
      color: #999;
      font-size: 24px;
      position: absolute;
      top: 15px;
      right: 15px;
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .close-settle-btn:hover {
      color: #333;
    }
    
    /* 库存管理相关样式 */
    .inventory-panel {
      margin-top: 30px;
      padding: 25px;
      background: rgba(255,255,255,0.58);
      border-radius: 22px;
      box-shadow: 0 4px 26px 0 rgba(90,140,230,.06);
      backdrop-filter: blur(16px);
      border: 1.5px solid #d5e5fc;
    }
    
    .inventory-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .inventory-title {
      font-size: 1.6rem;
      font-weight: 800;
      color: #3161b8;
      letter-spacing: 0.02em;
      margin: 0;
    }
    
    .add-inventory-btn {
      background: linear-gradient(90deg, #7dbafd 10%, #d5e4ff 90%);
      color: #1456b5;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      padding: 10px 25px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
    }
    
    .add-inventory-btn:hover {
      background: linear-gradient(90deg, #457bdd 30%, #badcff 100%);
      transform: translateY(-2px);
    }
    
    .inventory-summary {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .summary-card {
      background: rgba(240,250,255,0.7);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 1px 6px 0 rgba(160,170,255,.04);
      text-align: center;
      position: relative;
    }
    
    .summary-card h3 {
      margin-top: 0;
      color: #3161b8;
      font-size: 1.1rem;
      cursor: pointer;
    }
    
    .summary-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #3776f8;
      margin: 10px 0;
    }
    
    .summary-label {
      font-size: 0.9rem;
      color: #777;
      margin-bottom: 10px;
    }
    
    .product-details {
      background: rgba(255,255,255,0.8);
      border-radius: 12px;
      padding: 15px;
      margin-top: 10px;
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e0e8ff;
      display: none;
    }
    
    .product-detail-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f0f4ff;
    }
    
    .product-detail-item:last-child {
      border-bottom: none;
    }
    
    .detail-name {
      font-weight: 600;
      color: #3161b8;
    }
    
    .detail-value {
      color: #555;
    }
    
    .summary-card.expanded .product-details {
      display: block;
    }
    
    .expand-icon {
      position: absolute;
      right: 15px;
      top: 15px;
      font-size: 18px;
      cursor: pointer;
      color: #3161b8;
    }
    
    /* 新增统计区域样式 */
    .stats-grid {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    
    .stat-item {
      background: rgba(240, 250, 255, 0.7);
      padding: 16px 26px;
      border-radius: 16px;
      box-shadow: 0 1px 6px 0 rgba(160, 170, 255, 0.04);
      text-align: center;
      min-width: 120px;
    }
    
    .stat-value {
      font-size: 2.2rem;
      font-weight: 900;
      color: #3161b8;
      margin-bottom: 6px;
    }
    
    .stat-label {
      font-size: 1.0rem;
      color: #5577aa;
      letter-spacing: 0.02em;
    }
    
    .inventory-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255,255,255,0.83);
      border-radius: 18px;
      overflow: hidden;
      box-shadow:0 3px 14px #c1d7fa24;
      backdrop-filter: blur(8px);
    }
    
    .inventory-table th, .inventory-table td {
      padding: 15px 10px;
      text-align: center;
      border-bottom: 1.5px solid #f0f4fc;
    }
    
    .inventory-table th {
      background: rgba(216,236,255,0.84);
      font-weight: 900;
      color: #3476bb;
      border-bottom: 2.5px solid #bed9f9;
    }
    
    .inventory-table tr:last-child td {
      border-bottom: none;
    }
    
    .inventory-table tr:hover {
      background-color: rgba(245, 249, 255, 0.7);
    }
    
    .stock-low {
      color: #e74c3c;
      font-weight: bold;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .stock-ok {
      color: #27ae60;
      font-weight: bold;
    }
    
    .stock-zero {
      color: #e74c3c;
      font-weight: bold;
      background: rgba(231, 76, 60, 0.1);
      border-radius: 4px;
      padding: 2px 8px;
    }
    
    .inventory-actions {
      display: flex;
      justify-content: center;
      gap: 8px;
    }
    
    .action-btn {
      padding: 6px 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .add-stock-btn {
      background: #27ae60;
      color: white;
    }
    
    .add-stock-btn:hover {
      background: #219653;
    }
    
    .edit-product-btn {
      background: #3498db;
      color: white;
    }
    
    .edit-product-btn:hover {
      background: #2980b9;
    }
    
    .delete-product-btn {
      background: #e74c3c;
      color: white;
    }
    
    .delete-product-btn:hover {
      background: #c0392b;
    }
    
    .stock-input {
      width: 60px;
      padding: 5px;
      border-radius: 5px;
      border: 1px solid #ddd;
      text-align: center;
    }
    
    .stock-info {
      display: block;
      font-size: 14px;
      margin-top: 5px;
      color: #3161b8;
      font-weight: bold;
    }
    
    /* 关键修复：添加隐藏类 */
    .hidden { display: none !important; }
    
    @media (max-width:700px){
      .container{padding:16px 2vw 36px 2vw;}
      .header-bar{padding:0 3vw; font-size:15px;}
      .user-glassbox{padding:18px 3vw 8px 3vw;}
      .admin-user-btn{font-size:14px;padding:8px 10px;}
      .admin-table th, .admin-table td{padding:10px 3px;}
      .admin-notification{font-size:16px;min-width:160px;}
      .modal-box{padding:18px 8px;}
      .inventory-summary {grid-template-columns: 1fr;}
      .stats-grid {flex-direction: column; gap: 12px;}
      .btn-group { gap: 15px; }
      .main-btn { padding: 10px 20px; font-size: 16px; }
      .login-center { flex-direction: column; }
      .login-center-btn { width: 100%; justify-content: center; }
    }
    
    .table-filter-bar {
      margin: 10px 0 12px 0;
      font-size: 15px;
      color: #367;
      user-select: none;
    }
    
    .table-filter-bar select, .table-filter-bar button {
      margin-left: 7px; margin-right: 10px;
      border-radius: 7px;
      padding: 2px 12px;
      font-size: 15px;
      border: 1px solid #b6d5ff;
      background: #f4f9fe;
      cursor: pointer;
    }
    
    .sort-arrow {font-size: 12px;}
    
    /* 新增：数量显示样式 */
    .quantity-display {
      display: inline-block;
      background: #e6f0ff;
      border-radius: 8px;
      padding: 2px 8px;
      font-weight: bold;
      color: #3161b8;
      margin-left: 5px;
    }
    
    /* 结账按钮 */
    .settle-action-btn {
      padding: 8px 20px;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      background: var(--accent-color);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: 10px;
    }
    
    .settle-action-btn:hover {
      background: #2fad7a;
      transform: translateY(-2px);
    }
    
    .settle-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 2px dashed #e0e8ff;
    }
    
    .settle-total-amount {
      font-size: 22px;
      font-weight: 800;
      color: var(--warning-color);
    }
    
    /* 未登录商品展示 */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    
    .product-card {
      background: rgba(255, 255, 255, 0.7);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      transition: all 0.3s;
      border: 1px solid #e0e8ff;
    }
    
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .product-image {
      width: 100px;
      height: 100px;
      margin: 0 auto 15px;
      border-radius: 12px;
      background: #f0f8ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      color: #a6c8ff;
    }
    
    .product-name {
      font-weight: bold;
      color: var(--text-dark);
      margin-bottom: 8px;
      font-size: 18px;
    }
    
    .product-price {
      font-size: 20px;
      font-weight: 800;
      color: var(--primary-color);
      margin-bottom: 15px;
    }
    
    .product-action {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      opacity: 0.8;
    }
    
    .product-action:hover {
      opacity: 1;
      transform: translateY(-2px);
    }
    
    .login-required {
      margin-top: 20px;
      text-align: center;
      font-size: 16px;
      color: #666;
      font-weight: 500;
    }
    
    /* 图标字体 */
    @font-face {
      font-family: 'Material Icons';
      font-style: normal;
      font-weight: 400;
      src: url(https://fonts.gstatic.com/s/materialicons/v140/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2) format('woff2');
    }
    
    .material-icons {
      font-family: 'Material Icons';
      font-weight: normal;
      font-style: normal;
      font-size: 24px;
      line-height: 1;
      letter-spacing: normal;
      text-transform: none;
      display: inline-block;
      white-space: nowrap;
      word-wrap: normal;
      direction: ltr;
      -webkit-font-feature-settings: 'liga';
      -webkit-font-smoothing: antialiased;
    }
/* ===== 毛玻璃弹窗科技感UI+动效加强 ===== */
.modal {
  position: fixed; inset: 0; z-index: 30000;
  background: linear-gradient(130deg,rgba(36,70,150,0.14) 0%,rgba(40,160,255,0.10) 100%);
  display: flex; align-items: center; justify-content: center;
  backdrop-filter: blur(10px) brightness(1.08) saturate(1.16);
  transition: all .22s cubic-bezier(.6,0,.2,1.2);
  animation: fadeInModal .25s;
}
@keyframes fadeInModal { from{opacity:0;} to{opacity:1;} }
.modal.hidden { display: none !important; }
.modal-box {
  position: relative; min-width: 440px; max-width: 98vw; min-height: 320px;
  padding: 54px 64px 38px 64px;
  background: rgba(252, 254, 255, 0.81);
  border-radius: 30px;
  box-shadow:
    0 14px 64px 0 rgba(38,60,180,.18),
    0 2px 10px 0 rgba(90,160,255,.09);
  backdrop-filter: blur(22px) saturate(1.32);
  border: 2.2px solid rgba(80,145,255,0.12);
  display: flex; flex-direction: column; align-items: center;
  animation: modalGlassShow .3s cubic-bezier(.4,2,.3,1.1);
  overflow-y: auto;
}
@keyframes modalGlassShow {
  0% { opacity: 0; transform: translateY(60px) scale(.93);}
  100% { opacity: 1; transform: translateY(0) scale(1);}
}
.modal-box h2 {
  font-size: 2.2rem; font-weight: 900; margin-bottom: 32px;
  background: linear-gradient(92deg,#5faaff 30%,#3776f8 90%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  text-align: center; text-shadow: 0 2px 10px #aad7ff2f;
  letter-spacing: 0.09em;
}
.modal-box input[type="text"],
.modal-box input[type="password"],
.modal-box input[type="number"] {
  width: 100%; margin: 10px 0 24px 0; padding: 16px 18px;
  border-radius: 13px; border: 2px solid #bad6ff;
  font-size: 1.17rem; background: rgba(255,255,255,0.62);
  box-shadow: 0 2px 10px #bee6ff17; color: #225; outline: none;
  transition: border 0.19s, box-shadow 0.19s, transform .18s;
  backdrop-filter: blur(2.5px);
}
.modal-box input:focus {
  border-color: #54b7ff;
  background: rgba(255,255,255,0.85);
  box-shadow: 0 4px 18px #6ac9ff30;
  transform: scale(1.025);
}
.modal-box .form-label {
  font-weight: 700; color: #3776f8; margin: 8px 0 -4px 0;
  font-size: 1.14rem; width: 100%; text-align: left; letter-spacing: 0.03em;
}
.modal-box .tip {
  color: #e45c6c; background: rgba(240, 244, 255, 0.92);
  border-radius: 13px; margin-bottom: 16px; padding: 12px 0;
  font-size: 15.7px; text-align: center; width: 100%; font-weight: bold;
  letter-spacing: 0.04em; border: 1.5px solid #fbe3ec;
}
.modal-box .tip.success {
  color: #179963; background: #e5faed; border: 1.5px solid #b2e6ce;
}
.modal-box .main-btn {
  width: 100%; margin: 20px 0 0 0; padding: 16px 0;
  border-radius: 19px; font-size: 1.16rem;
  background: linear-gradient(90deg,#45e6ff 6%,#3c87ff 48%,#b9e7ff 100%);
  color: #2050a5; font-weight: 900; border: none;
  box-shadow: 0 8px 30px 0 rgba(90,160,255,.13);
  transition: all .18s cubic-bezier(.4,0,.2,1.1);
  letter-spacing: 0.07em; position: relative; overflow: hidden;
}
.modal-box .main-btn::after {
  content: ""; position: absolute; left: 0; top: 0; width: 0; height: 100%;
  background: linear-gradient(87deg,#56eaff 0,#5f9eff 80%,#b6eaff 100%);
  opacity: 0.16; transition: width .23s cubic-bezier(.3,1.2,.5,1);
  z-index: 1;
}
.modal-box .main-btn:hover::after {
  width: 100%;
}
.modal-box .main-btn:hover {
  color: #fff; background: linear-gradient(90deg,#458cff 6%,#49d6ff 95%);
  box-shadow: 0 16px 40px rgba(80,155,255,.19);
  transform: translateY(-1.5px) scale(1.016);
}

.modal-box .close-settle-btn {
  position: absolute; right: 20px; top: 18px;
  color: #58a2ff; font-size: 28px;
  background: none; border: none; cursor: pointer;
  z-index: 1001; transition: color 0.18s, background 0.12s;
  border-radius: 50%; padding: 2px 7px; line-height: 1;
}
.modal-box .close-settle-btn:hover {
  color: #e74c3c; background: rgba(250,220,220,0.17);
}

.modal-box .switch-link {
  margin-top: 25px;
  color: #3776f8;
  background: none;
  border: none;
  font-size: 1.06rem;
  font-weight: 600;
  letter-spacing: 0.04em;
  cursor: pointer;
  text-decoration: underline;
  transition: color .18s;
}
.modal-box .switch-link:hover {
  color: #d14848;
}

/* 手机适配 */
@media (max-width:700px){
  .modal-box { min-width: 0; width: 99vw; padding: 21px 3vw 18px 3vw; border-radius: 19px; max-width: 99vw; }
  .modal-box h2 { font-size: 1.3rem; margin-bottom: 13px; }
  .modal-box .main-btn { font-size: 15px; padding: 11px 0; }
}
/* 在 <style> 最后追加 */
.custom-modal-btn {
  background: linear-gradient(90deg, #7dbafd 10%, #d5e4ff 90%);
  color: #2050a5;
  font-weight: bold;
  border: none;
  border-radius: 12px;
  padding: 10px 25px;
  margin: 0 8px 10px 8px;
  font-size: 16px;
  box-shadow: 0 2px 8px #e6f4ff23;
  transition: all .19s cubic-bezier(.4,0,.2,1.1);
  cursor: pointer;
  min-width: 90px;
}
.custom-modal-btn:hover {
  background: linear-gradient(90deg, #458cff 20%, #49d6ff 100%);
  color: #fff;
  transform: translateY(-2px);
}
.custom-modal-btn.custom-cancel {
  background: #e8eaef;
  color: #6a768e;
}
.custom-modal-btn.custom-cancel:hover {
  background: #dadde2;
  color: #c00;
}
.custom-modal-btn-row {
  display: flex;
  justify-content: center;
  gap: 22px;
  margin-top: 18px;
  margin-bottom: 4px;
}
.custom-modal-btn {
  min-width: 96px;
  padding: 11px 0;
  font-size: 16px;
  font-weight: 800;
  border-radius: 11px;
  border: none;
  cursor: pointer;
  transition: all 0.18s cubic-bezier(.5,.2,.2,1.1);
  box-shadow: 0 2px 8px #e6f4ff23;
}
.custom-modal-btn.custom-confirm {
  background: linear-gradient(90deg, #ff5e62 0, #ff9966 100%);
  color: #fff;
}
.custom-modal-btn.custom-confirm:hover {
  background: linear-gradient(90deg, #ff2c42 0, #ffae8e 100%);
}
.custom-modal-btn.custom-cancel {
  background: #eef2f7;
  color: #6a768e;
}
.custom-modal-btn.custom-cancel:hover {
  background: #e0e0e7;
  color: #b00;
}
@media (max-width:700px){
  .custom-modal-btn-row { gap: 10px; }
  .custom-modal-btn { min-width: 70px; font-size: 15px; padding: 10px 0; }
}
  </style>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <div class="header-bar">
    <span class="user-info" id="userInfo" style="display:none;"></span>
    <button class="login-btn" id="loginBtn" onclick="showLoginModal()">登录</button>
    <button class="register-btn" id="registerBtn" onclick="showRegisterModal()">注册</button>
    <button class="change-pwd-btn" id="changePwdBtn" style="display:none;" onclick="showChangePwdModal()">修改密码</button>
    <button class="logout-btn" id="logoutBtn" style="display:none;" onclick="logout()">退出</button>
  </div>
  
  <!-- 管理员弹窗 -->
  <div class="admin-popup" id="adminPopup">
    <div class="admin-popup-title" id="adminPopupTitle">新订单通知</div>
    <div class="admin-popup-content" id="adminPopupContent"></div>
    <button class="admin-popup-btn" onclick="document.getElementById('adminPopup').style.display='none'">知道了</button>
  </div>
  
  <!-- 结账弹窗 -->
  <div class="settle-modal" id="settleModal">
    <button class="close-settle-btn" onclick="closeSettleModal()">&times;</button>
    <div class="settle-header">扫码支付</div>
    <div class="settle-amount" id="settleAmount">$0.00</div>
    
    <div class="qr-container">
      <img src="https://i.postimg.cc/7Zyr0mvJ/photo-2025-07-15-09-18-21.jpg" alt="收款二维码">
    </div>
    
    <div class="settle-instructions">
      <p><strong>支付步骤：</strong></p>
      <ol>
        <li>打开手机支付APP（汇旺）</li>
        <li>点击"扫一扫"扫描上方二维码</li>
        <li>输入支付金额：<span id="settleAmountText">$0.00</span></li>
        <li>完成支付后点击下方"确认付款"按钮</li>
      </ol>
    </div>
    
    <button class="confirm-payment-btn" onclick="confirmPayment()">
      <i class="material-icons">check_circle</i> 确认付款
    </button>
    
    <div class="settle-footer">
      支付成功后，管理员将确认您的付款并更新订单状态
    </div>
  </div>
  
  <div class="container">
    <h1>消费！！！</h1>
    
    <!-- 中央登录注册区域 -->
    <div id="loginCenter" class="login-center" style="display:none;">
      <button class="login-center-btn" onclick="showLoginModal()">
        <i class="material-icons">login</i> 登录
      </button>
      <button class="login-center-btn" onclick="showRegisterModal()">
        <i class="material-icons">person_add</i> 注册
      </button>
    </div>
    
    <!-- 未登录商品展示 -->
    <div id="guestProducts" class="hidden">
      <h2 style="text-align:center; margin:30px 0 20px; color:#3161b8;">热门商品</h2>
      <div class="products-grid" id="guestProductsGrid"></div>
      <div class="login-required">
        <p>登录后可下单购买商品并查看消费记录</p>
      </div>
    </div>
    
    <div id="systemPanel">
      <!-- 商品按钮区域（动态生成） -->
      <div class="btn-group" id="productButtons">
        <!-- 商品按钮将在这里动态生成 -->
      </div>
      <div id="loginTip" class="tip" style="display:none;"></div>
      <h2 style="margin:20px 0 18px 0;letter-spacing:0.02em;font-weight:800;color:#3161b8;">我的消费记录</h2>
      <div id="userSummaryBox"></div>
    </div>
    
    <div id="adminPanelWrap" class="section hidden">
      <h2 style="margin-top:32px;margin-bottom:18px;font-weight:900;color:#222;">管理员后台</h2>
      <div id="adminUserList" class="admin-user-list"></div>
      <div id="tableFilterBar" class="table-filter-bar"></div>
      <div id="adminUserDetail" class="hidden"></div>
      <div id="notificationBox" class="notification" style="display:none;margin-top:18px;"></div>

      <!-- 库存管理区域 -->
      <div class="inventory-panel">
        <div class="inventory-header">
          <h2 class="inventory-title">库存管理</h2>
          <button class="add-inventory-btn" onclick="showAddProductModal()">添加商品</button>
        </div>

        <div class="inventory-summary">
          <div class="summary-card">
            <div class="expand-icon" onclick="toggleDetails(this)">▼</div>
            <h3>总商品库存</h3>
            <div class="summary-value" id="totalInventory">0</div>
            <div class="summary-label">所有商品库存总量</div>
            <div class="product-details" id="totalInventoryDetails">
              <!-- 动态填充 -->
            </div>
          </div>
          <div class="summary-card">
            <div class="expand-icon" onclick="toggleDetails(this)">▼</div>
            <h3>剩余商品库存</h3>
            <div class="summary-value" id="remainingInventory">0</div>
            <div class="summary-label">可供销售的商品数量</div>
            <div class="product-details" id="remainingInventoryDetails">
              <!-- 动态填充 -->
            </div>
          </div>
          <div class="summary-card">
            <div class="expand-icon" onclick="toggleDetails(this)">▼</div>
            <h3>已消费商品</h3>
            <div class="summary-value" id="consumedInventory">0</div>
            <div class="summary-label">已销售的商品数量</div>
            <div class="product-details" id="consumedInventoryDetails">
              <!-- 动态填充 -->
            </div>
          </div>
          <div class="summary-card">
            <div class="expand-icon" onclick="toggleDetails(this)">▼</div>
            <h3>库存已结账金额</h3>
            <div class="summary-value" id="settledAmount">$0</div>
            <div class="summary-label">已结账的库存金额</div>
            <div class="product-details" id="settledAmountDetails">
              <!-- 动态填充 -->
            </div>
          </div>
          <div class="summary-card">
            <div class="expand-icon" onclick="toggleDetails(this)">▼</div>
            <h3>库存未结账金额</h3>
            <div class="summary-value" id="unsettledAmount">$0</div>
            <div class="summary-label">未结账的库存金额</div>
            <div class="product-details" id="unsettledAmountDetails">
              <!-- 动态填充 -->
            </div>
          </div>
          <div class="summary-card">
            <div class="expand-icon" onclick="toggleDetails(this)">▼</div>
            <h3>库存总金额</h3>
            <div class="summary-value" id="totalInventoryValue">$0</div>
            <div class="summary-label">所有商品剩余库存的总金额</div>
            <div class="product-details" id="totalInventoryValueDetails">
              <!-- 动态填充 -->
            </div>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="totalProducts">0</div>
            <div class="stat-label">商品种类</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="lowStockProducts">0</div>
            <div class="stat-label">库存预警商品</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="outOfStockProducts">0</div>
            <div class="stat-label">缺货商品</div>
          </div>
        </div>

        <table class="inventory-table">
          <thead>
            <tr>
              <th>商品名称</th>
              <th>单价</th>
              <th>总库存</th>
              <th>剩余库存</th>
              <th>已售出</th>
              <th>库存状态</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="inventoryTableBody">
            <!-- 动态填充库存数据 -->
          </tbody>
        </table>
      </div>
    </div>
    <div class="admin-notification" id="adminNotification"></div>
  </div>

  <!-- 登录弹窗 -->
  <div class="modal hidden" id="loginModal">
    <div class="modal-box">
      <h2>登录</h2>
      <div class="tip" id="loginModalTip"></div>
      <div class="form-label">账号（中文2-6字）</div>
      <input type="text" id="loginName" maxlength="6" />
      <div class="form-label">密码</div>
      <input type="password" id="loginPwd" maxlength="20" />
      <br />
      <button onclick="doLogin()" class="main-btn" style="width:85%;margin-top:5px;">登录</button>
      <div style="margin-top:14px;color:#555;font-size:13px;">没有账号？请点击右上角"注册"</div>
    </div>
  </div>

  <!-- 注册弹窗 -->
  <div class="modal hidden" id="registerModal">
    <div class="modal-box">
      <h2>注册</h2>
      <div class="tip" id="registerModalTip"></div>
      <div class="form-label">账号（2-6位中文）</div>
      <input type="text" id="registerName" maxlength="6" />
      <div class="form-label">密码（6-20位）</div>
      <input type="password" id="registerPwd" maxlength="20" />
      <br />
      <button onclick="doRegister()" class="main-btn" style="width:85%;margin-top:5px;">注册</button>
      <div style="margin-top:14px;color:#555;font-size:13px;">已有账号？请点击右上角"登录"</div>
    </div>
  </div>
  
  <!-- 修改密码弹窗 -->
  <div class="modal hidden" id="changePwdModal">
    <div class="modal-box">
      <h2>修改密码</h2>
      <div class="tip" id="changePwdTip"></div>
      <div class="form-label">旧密码</div>
      <input type="password" id="oldPwd" maxlength="20" />
      <div class="form-label">新密码（6-20位）</div>
      <input type="password" id="newPwd" maxlength="20" />
      <div class="form-label">确认新密码</div>
      <input type="password" id="confirmNewPwd" maxlength="20" />
      <br />
      <button onclick="changePassword()" class="main-btn" style="width:85%;margin-top:5px;">修改密码</button>
      <button onclick="document.getElementById('changePwdModal').classList.add('hidden')" class="main-btn" style="width:85%;margin-top:10px;background:#eee;color:#555;">取消</button>
    </div>
  </div>

  <!-- 自定义弹窗 -->
  <div class="modal hidden" id="customModal">
    <div class="modal-box" id="customModalBox"></div>
  </div>

  <!-- 添加商品弹窗 -->
  <div class="modal hidden" id="addProductModal">
    <div class="modal-box">
      <h2>添加商品</h2>
      <div class="tip" id="addProductTip"></div>
      <div class="form-label">商品名称</div>
      <input type="text" id="productName" />
      <div class="form-label">单价</div>
      <input type="number" id="productPrice" min="1" />
      <div class="form-label">初始库存</div>
      <input type="number" id="productStock" min="0" />
      <div class="form-label">每次下单数量</div>
      <input type="number" id="productPerOrder" min="0.01" step="0.01" value="1" />
      <br />
      <button onclick="addProduct()" class="main-btn" style="width:85%;margin-top:5px;">添加</button>
      <button onclick="document.getElementById('addProductModal').classList.add('hidden')" class="main-btn" style="width:85%;margin-top:10px;background:#eee;color:#555;">取消</button>
    </div>
  </div>

  <!-- 编辑商品弹窗 -->
  <div class="modal hidden" id="editProductModal">
    <div class="modal-box">
      <h2>编辑商品</h2>
      <div class="tip" id="editProductTip"></div>
      <div class="form-label">商品名称</div>
      <input type="text" id="editProductName" />
      <div class="form-label">单价</div>
      <input type="number" id="editProductPrice" min="1" />
      <div class="form-label">总库存</div>
      <input type="number" id="editProductStock" min="0" />
      <div class="form-label">每次下单数量</div>
      <input type="number" id="editProductPerOrder" min="0.01" step="0.01" value="1" />
      <br />
      <button onclick="updateProduct()" class="main-btn" style="width:85%;margin-top:5px;">保存</button>
      <button onclick="document.getElementById('editProductModal').classList.add('hidden')" class="main-btn" style="width:85%;margin-top:10px;background:#eee;color:#555;">取消</button>
    </div>
  </div>

  <!-- 编辑订单弹窗 -->
  <div class="modal hidden" id="editOrderModal">
    <div class="modal-box">
      <h2>编辑订单</h2>
      <div class="tip" id="editOrderTip"></div>
      <div class="form-label">金额</div>
      <input type="number" id="editOrderPrice" min="0" step="0.01" />
      <div class="form-label">数量</div>
      <input type="number" id="editOrderQuantity" min="0.01" step="0.01" />
      <br />
      <button onclick="saveOrderChanges()" class="main-btn" style="width:85%;margin-top:5px;">保存</button>
      <button onclick="document.getElementById('editOrderModal').classList.add('hidden')" class="main-btn" style="width:85%;margin-top:10px;background:#eee;color:#555;">取消</button>
    </div>
  </div>

  <!-- 替换为有效的音频资源 -->
  <audio id="ding" src="https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3" preload="auto"></audio>
  
  <script>
  // ========== 补充弹窗函数 ==========
  function showLoginModal() {
    document.getElementById('loginModal').classList.remove('hidden');
    document.getElementById('loginModalTip').textContent = "";
    setTimeout(() => {
      document.querySelector('#loginModal input[type="text"]')?.focus();
    }, 160);
  }
  
  function showRegisterModal() {
    document.getElementById('registerModal').classList.remove('hidden');
    document.getElementById('registerModalTip').textContent = "";
    setTimeout(() => {
      document.querySelector('#registerModal input[type="text"]')?.focus();
    }, 160);
  }
  
  // 显示修改密码弹窗
  function showChangePwdModal() {
    document.getElementById('changePwdModal').classList.remove('hidden');
    document.getElementById('changePwdTip').textContent = "";
    document.getElementById('oldPwd').value = '';
    document.getElementById('newPwd').value = '';
    document.getElementById('confirmNewPwd').value = '';
    setTimeout(() => {
      document.getElementById('oldPwd').focus();
    }, 160);
  }
  
  // ========== 原有脚本开始 ==========

  // Firebase 初始化
  var firebaseConfig = {
    apiKey: "AIzaSyAMMVskugyJX1dpSABKclClgFSTDLOkDlE",
    authDomain: "binglang.firebaseapp.com",
    databaseURL: "https://binglang-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "binglang",
    storageBucket: "binglang.firebasestorage.app",
    messagingSenderId: "557652181369",
    appId: "1:557652181369:web:da3efc3e6b8d1834686fa8"
  };
  firebase.initializeApp(firebaseConfig);
  var db = firebase.database();

    let currentUser = null;
    let users = {};
    let orders = [];
    let orderCount = 0;
    let lastOrderIds = [];
    let isAdminAccount = false;
    let adminDetailUser = "__ALL__";
    let currentFilter = "all";
    let currentSort = { key: "id", asc: true };
    let inventory = [];
    let currentEditProduct = null;
    let currentEditOrder = null;
    let inventoryListenerActive = false;
    let currentSettleOrder = null;
    let currentSettleAll = false;

    // 获取库存数组
    function getInventoryArray() {
      return Array.isArray(inventory) ? inventory : Object.values(inventory || {});
    }

    // 初始化库存
    function initInventory() {
      db.ref('inventory').once('value').then(snapshot => {
        if (!snapshot.exists()) {
          const initialProducts = [
            { name: "槟榔(5元)", price: 5, totalStock: 100, remainingStock: 100, sold: 0, settledAmount: 0, unsettledAmount: 0, perOrder: 0.25 },
            { name: "槟榔(20元)", price: 20, totalStock: 100, remainingStock: 100, sold: 0, settledAmount: 0, unsettledAmount: 0, perOrder: 1 },
            { name: "灰狼(35元)", price: 35, totalStock: 50, remainingStock: 50, sold: 0, settledAmount: 0, unsettledAmount: 0, perOrder: 1 }
          ];
          db.ref('inventory').set(initialProducts);
          inventory = initialProducts;
        } else {
          inventory = snapshot.val();
        }
        updateInventoryUI();
        updateStockStatus();
        renderProductButtons();
        renderGuestProducts(); // 渲染访客商品展示
      });
    }

    // 监听库存变化
    function listenInventory() {
      if (inventoryListenerActive) return;
      db.ref('inventory').on('value', snapshot => {
        inventory = snapshot.val() || [];
        updateInventoryUI();
        updateStockStatus();
        renderProductButtons();
        renderGuestProducts(); // 更新访客商品展示
      });
      inventoryListenerActive = true;
    }

    // 渲染访客商品展示
    function renderGuestProducts() {
      const container = document.getElementById('guestProductsGrid');
      if (!container) return;
      
      container.innerHTML = '';
      const invArr = getInventoryArray();
      
      invArr.forEach(product => {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
          <div class="product-image">
            <i class="material-icons">shopping_bag</i>
          </div>
          <div class="product-name">${product.name}</div>
          <div class="product-price">$${product.price}</div>
          <button class="product-action" onclick="showLoginForPurchase()">立即购买</button>
        `;
        container.appendChild(card);
      });
    }

    // 显示登录提示
    function showLoginForPurchase() {
      showLoginModal();
      showNotification('请登录后购买商品');
    }

    // 渲染商品购买按钮
    function renderProductButtons() {
      const container = document.getElementById('productButtons');
      if (!container) return;
      
      container.innerHTML = '';
      const invArr = getInventoryArray();
      
      invArr.forEach(product => {
        const button = document.createElement('button');
        button.className = 'main-btn';
        button.onclick = () => addItem(product.name);
        button.innerHTML = `
          购买${product.name}
          <span class="stock-info" id="stock-${product.name.replace(/[^a-zA-Z0-9]/g, '')}-info">库存: ${product.remainingStock}</span>
        `;
        container.appendChild(button);
      });
      
      updateStockStatus();
    }

    // 更新库存UI
    function updateInventoryUI() {
      const invArr = getInventoryArray();
      if (invArr.length === 0) return;

      // 更新统计卡片
      const totalInventory = invArr.reduce((sum, i) => sum + (i.totalStock || 0), 0);
      const remainingInventory = invArr.reduce((sum, i) => sum + (i.remainingStock || 0), 0);
      const consumedInventory = invArr.reduce((sum, i) => sum + (i.sold || 0), 0);
      const settledAmount = invArr.reduce((sum, i) => sum + (i.settledAmount || 0), 0);
      const unsettledAmount = invArr.reduce((sum, i) => sum + (i.unsettledAmount || 0), 0);
      const totalInventoryValue = invArr.reduce((sum, i) => sum + (i.remainingStock || 0) * (i.price || 0), 0);

      document.getElementById('totalInventory').textContent = totalInventory;
      document.getElementById('remainingInventory').textContent = remainingInventory;
      document.getElementById('consumedInventory').textContent = consumedInventory;
      document.getElementById('settledAmount').textContent = '$' + settledAmount.toFixed(2);
      document.getElementById('unsettledAmount').textContent = '$' + unsettledAmount.toFixed(2);
      document.getElementById('totalInventoryValue').textContent = '$' + totalInventoryValue.toFixed(2);

      // 更新详细商品信息
      updateInventoryDetails('totalInventoryDetails', '总库存', invArr, 'totalStock');
      updateInventoryDetails('remainingInventoryDetails', '剩余库存', invArr, 'remainingStock');
      updateInventoryDetails('consumedInventoryDetails', '已售出', invArr, 'sold');
      updateInventoryDetails('settledAmountDetails', '已结账金额', invArr, 'settledAmount', true);
      updateInventoryDetails('unsettledAmountDetails', '未结账金额', invArr, 'unsettledAmount', true);
      updateInventoryDetails('totalInventoryValueDetails', '库存价值', invArr, null, true, true);

      document.getElementById('totalProducts').textContent = invArr.length;
      document.getElementById('lowStockProducts').textContent = invArr.filter(i => (i.remainingStock > 0) && (i.remainingStock <= i.totalStock * 0.2)).length;
      document.getElementById('outOfStockProducts').textContent = invArr.filter(i => i.remainingStock === 0).length;

      // 更新库存表格
      const tableBody = document.getElementById('inventoryTableBody');
      tableBody.innerHTML = '';
      invArr.forEach((product, index) => {
        let statusClass = '', statusText = '';
        if (product.remainingStock === 0) {
          statusClass = 'stock-zero';
          statusText = '缺货';
        } else if (product.remainingStock <= product.totalStock * 0.2) {
          statusClass = 'stock-low';
          statusText = '库存不足';
        } else {
          statusClass = 'stock-ok';
          statusText = '库存充足';
        }
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${product.name}</td>
          <td>$${product.price}</td>
          <td>${product.totalStock}</td>
          <td>${product.remainingStock}</td>
          <td>${product.sold}</td>
          <td class="${statusClass}">${statusText}</td>
          <td class="inventory-actions">
            <button class="action-btn add-stock-btn" onclick="addStock(${index})">加库存</button>
            <button class="action-btn edit-product-btn" onclick="editProduct(${index})">编辑</button>
            <button class="action-btn delete-product-btn" onclick="deleteProduct(${index})">删除</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    // 更新库存详细数据
    function updateInventoryDetails(elementId, title, products, property, isMoney = false, isValue = false) {
      const element = document.getElementById(elementId);
      let html = '';
      
      if (products.length > 0) {
        products.forEach(product => {
          let value = '';
          if (isValue) {
            value = '$' + (product.remainingStock * product.price).toFixed(2);
          } else if (property) {
            value = isMoney ? '$' + (product[property] || 0).toFixed(2) : product[property];
          }
          
          html += `<div class="product-detail-item">
            <span class="detail-name">${product.name}</span>
            <span class="detail-value">${value}</span>
          </div>`;
        });
      } else {
        html = '<div style="text-align:center;padding:10px;color:#888;">暂无数据</div>';
      }
      
      element.innerHTML = html;
    }

    // 更新按钮库存状态
    function updateStockStatus() {
      const invArr = getInventoryArray();
      if (invArr.length === 0) return;

      invArr.forEach(product => {
        const btnId = `stock-${product.name.replace(/[^a-zA-Z0-9]/g, '')}`;
        const stockInfo = document.getElementById(`${btnId}-info`);
        
        if (stockInfo) {
          stockInfo.textContent = `库存: ${product.remainingStock}`;
          stockInfo.style.color = product.remainingStock < product.perOrder ? '#e74c3c' : '#3161b8';
        }
      });
    }

    // 展开/折叠详细库存信息
    function toggleDetails(icon) {
      const card = icon.parentElement;
      card.classList.toggle('expanded');
      icon.textContent = card.classList.contains('expanded') ? '▲' : '▼';
    }

    // 加库存弹窗
    function addStock(index) {
      const product = getInventoryArray()[index];
      if (!product) return;
      customPrompt(`为 ${product.name} 添加库存（当前库存：${product.remainingStock}）`, value => {
        if (value === false) return;
        const n = parseInt(value);
        if (isNaN(n) || n <= 0) {
          customAlert("请输入有效的正整数库存数量！");
          return;
        }
        const newTotal = product.totalStock + n;
        const newRemaining = product.remainingStock + n;
        db.ref(`inventory/${index}`).update({ totalStock: newTotal, remainingStock: newRemaining });
        showNotification(`已为 ${product.name} 添加 ${n} 库存`);
      });
    }

    // 编辑商品弹窗
    function editProduct(index) {
      const product = getInventoryArray()[index];
      if (!product) return;
      currentEditProduct = index;
      document.getElementById('editProductName').value = product.name;
      document.getElementById('editProductPrice').value = product.price;
      document.getElementById('editProductStock').value = product.totalStock;
      document.getElementById('editProductPerOrder').value = product.perOrder;
      document.getElementById('editProductTip').textContent = "";
      document.getElementById('editProductModal').classList.remove('hidden');
    }

    // 更新商品信息
    function updateProduct() {
      if (currentEditProduct === null) return;
      const name = document.getElementById('editProductName').value.trim();
      const price = parseFloat(document.getElementById('editProductPrice').value);
      const stock = parseInt(document.getElementById('editProductStock').value);
      const perOrder = parseFloat(document.getElementById('editProductPerOrder').value);
      const tip = document.getElementById('editProductTip');
      tip.textContent = "";

      if (!name) { tip.textContent = "商品名称不能为空"; return; }
      if (isNaN(price) || price <= 0) { tip.textContent = "请输入有效的价格"; return; }
      if (isNaN(stock) || stock < 0) { tip.textContent = "请输入有效的库存数量"; return; }
      if (isNaN(perOrder) || perOrder <= 0) { tip.textContent = "请输入有效的每次下单数量"; return; }

      const product = getInventoryArray()[currentEditProduct];
      const stockDiff = stock - product.totalStock;

      db.ref(`inventory/${currentEditProduct}`).update({
        name: name,
        price: price,
        totalStock: stock,
        remainingStock: product.remainingStock + stockDiff,
        perOrder: perOrder
      });

      document.getElementById('editProductModal').classList.add('hidden');
      showNotification(`商品 ${name} 已更新`);
    }

    // 删除商品
    function deleteProduct(index) {
      const product = getInventoryArray()[index];
      if (!product) return;
      customConfirm(`确定要删除商品 ${product.name} 吗？此操作不可撤销！`, ok => {
        if (!ok) return;
        const invArr = getInventoryArray();
        invArr.splice(index,1);
        db.ref('inventory').set(invArr);
        showNotification(`商品 ${product.name} 已删除`);
      }, { type: 'warn' });
    }

    // 监听用户数据
    function listenUsers() {
      db.ref('users').on('value', snapshot => {
        users = snapshot.val() || {};
        if (isAdminAccount) renderAdminUserList();
      });
    }
    listenUsers();

    // 监听订单数据
    function listenOrders() {
      db.ref('orders').on('value', snapshot => {
        const data = snapshot.val() || {};
        orders = Object.values(data);
        orderCount = orders.reduce((max, o) => Math.max(max, o.id || 0), 0);
        let ids = orders.map(o => o.id);

        if (isAdminAccount && ids.length > lastOrderIds.length) {
          let newOrders = orders.filter(o => !lastOrderIds.includes(o.id));
          if (newOrders.length > 0) {
            let latest = newOrders[newOrders.length - 1];
            if (latest.user !== currentUser) {
              showAdminPopup(`新订单：${latest.user} 下单了 ${latest.item}（$${latest.price}）`);
              document.getElementById('ding').play();
            }
          }
        }
        lastOrderIds = ids;

        if (currentUser) updateUserSummary();
        if (isAdminAccount) {
          renderAdminUserList();
          if (adminDetailUser) {
            if (adminDetailUser === "__ALL__") showAdminAllOrdersTable();
            else showAdminUserDetail(adminDetailUser, true);
          }
          renderFilterSortBar();
        }
      });
    }
    listenOrders();

    // 显示管理员弹窗
    function showAdminPopup(msg) {
      const popup = document.getElementById('adminPopup');
      const content = document.getElementById('adminPopupContent');
      content.textContent = msg;
      popup.style.display = 'block';
      
      clearTimeout(popup.timeout);
      popup.timeout = setTimeout(() => {
        popup.style.display = 'none';
      }, 5000);
    }

    // 下单
    function addItem(productName) {
      if (!currentUser) {
        updateUIByLoginState();
        customAlert("请登录后下单");
        return;
      }
      const invArr = getInventoryArray();
      const product = invArr.find(i => i.name === productName);
      if (!product) {
        customAlert(`商品 ${productName} 不存在！`);
        return;
      }
      const quantity = product.perOrder || 1;

      if (product.remainingStock < quantity) {
        customAlert(`商品 ${productName} 库存不足！`);
        return;
      }

      const now = new Date();
      orderCount++;
      const order = {
        id: orderCount,
        user: currentUser,
        item: productName,
        price: product.price,
        quantity: quantity,
        time: now.toLocaleString(),
        delivered: false,
        settled: false,
        paymentSubmitted: false // 新增支付提交状态
      };

      const newRemaining = product.remainingStock - quantity;
      db.ref('orders/' + order.id).set(order);
      db.ref(`inventory/${invArr.indexOf(product)}`).update({
        remainingStock: newRemaining,
        unsettledAmount: (product.unsettledAmount || 0) + product.price
      });
      showNotification(`下单成功：${productName}（$${product.price}）`);
    }

    // 更新用户消费记录显示
    function updateUserSummary() {
      const box = document.getElementById("userSummaryBox");
      if (!currentUser) {
        box.textContent = "请登录后查看。";
        return;
      }
      const userOrders = orders.filter(order => order.user === currentUser);
      if (userOrders.length === 0) {
        box.textContent = "当前没有任何消费记录。";
        return;
      }
      
      let html = `<div class="user-glassbox"><ul>`;
      userOrders.forEach(order => {
        const settleBtn = !order.settled ? `<button class="admin-btn settle-btn" onclick="settleOrder(${order.id})">结账</button>` : '';
        const paymentStatus = order.paymentSubmitted ? `<span class="li-status" style="background:rgba(253,115,115,0.19);color:#c00;border:1.2px solid #fda0a0;">待确认付款</span>` : '';
        
        html += `
        <li>
          <div class="li-desc">
            <span>${order.item}</span> 
            <span style="color:#3574f6;">$${order.price}</span>
            <span class="quantity-display">×${order.quantity}</span>
          </div>
          <div style="display:flex;align-items:center;gap:10px;">
            <span class="li-time">${order.time}</span>
            <span class="li-status ${order.delivered ? 'delivered' : 'undelivered'}">${order.delivered ? '已送货' : '未送货'}</span>
            <span class="li-status ${order.settled ? 'settled' : 'undelivered'}">${order.settled ? '已结账' : '未结账'}</span>
            ${paymentStatus}
            ${settleBtn}
          </div>
        </li>
        `;
      });
      
      const total = userOrders.reduce((sum, o) => sum + o.price, 0);
      const unsettledTotal = userOrders.filter(o => !o.settled).reduce((sum, o) => sum + o.price, 0);
      
      html += `
        <div class="settle-total">
          <div>
            <div style="font-weight:700;color:#184fa9;">共${userOrders.length}单，合计$${total}</div>
            <div style="font-weight:700;color:#e74c3c;">未结账金额: $${unsettledTotal}</div>
          </div>
          <button class="settle-action-btn" onclick="settleAllOrders()">全部结账</button>
        </div>
      `;
      
      html += `</div>`;
      box.innerHTML = html;
    }

    // 管理员用户列表渲染
    function renderAdminUserList() {
      if (!isAdminAccount) {
        document.getElementById("adminUserList").innerHTML = "";
        return;
      }
      const map = {};
      orders.forEach(o => {
        if (!map[o.user]) map[o.user] = [];
        map[o.user].push(o);
      });
      let html = `<button class="admin-user-btn${adminDetailUser === "__ALL__" ? ' active' : ''}" onclick="toggleAdminUserDetail('__ALL__')">全部订单明细</button>`;
      for (const user in map) {
        const count = map[user].length;
        const unsettledCount = map[user].filter(o => !o.settled).length;
        html += `
        <div style="margin-bottom:6px;">
          <button class="admin-user-btn${adminDetailUser === user ? ' active' : ''}" onclick="toggleAdminUserDetail('${user}')">${user}（${count}单）</button>
          <button class="admin-btn checkout-btn" onclick="checkoutUser('${user}')">结账</button>
          <span style="color:#e74c3c;font-size:14px;margin-left:5px;">${unsettledCount}未结</span>
        </div>
        `;
      }
      document.getElementById("adminUserList").innerHTML = html;
    }

    // 切换查看某用户订单明细
    function toggleAdminUserDetail(user) {
      adminDetailUser = user;
      if (user === "__ALL__") {
        showAdminAllOrdersTable();
      } else {
        showAdminUserDetail(user);
      }
      renderAdminUserList();
      renderFilterSortBar();
    }
    window.toggleAdminUserDetail = toggleAdminUserDetail;

    // 显示全部订单表
    function showAdminAllOrdersTable() {
      if (!isAdminAccount) return;
      let filteredOrders = orders;
      if (currentFilter === "delivered") filteredOrders = filteredOrders.filter(o => o.delivered);
      else if (currentFilter === "undelivered") filteredOrders = filteredOrders.filter(o => !o.delivered);

      filteredOrders = filteredOrders.slice();

      filteredOrders.sort((a, b) => {
        let valA = a[currentSort.key];
        let valB = b[currentSort.key];
        if (currentSort.key === "time") {
          valA = new Date(valA);
          valB = new Date(valB);
        }
        if (valA < valB) return currentSort.asc ? -1 : 1;
        if (valA > valB) return currentSort.asc ? 1 : -1;
        return 0;
      });

      const box = document.getElementById("adminUserDetail");
      if (filteredOrders.length === 0) {
        box.innerHTML = `<div style="text-align:center;margin:20px 0;">暂无订单。</div>`;
        box.classList.remove("hidden");
        return;
      }

      let html = `<table class="admin-table">
        <thead><tr>
          <th onclick="toggleSort('id')" style="cursor:pointer;">订单ID ${sortArrow('id')}</th>
          <th onclick="toggleSort('user')" style="cursor:pointer;">用户 ${sortArrow('user')}</th>
          <th onclick="toggleSort('item')" style="cursor:pointer;">商品 ${sortArrow('item')}</th>
          <th onclick="toggleSort('price')" style="cursor:pointer;">金额 ${sortArrow('price')}</th>
          <th>数量</th>
          <th onclick="toggleSort('time')" style="cursor:pointer;">下单时间 ${sortArrow('time')}</th>
          <th>送货状态</th>
          <th>结账状态</th>
          <th>操作</th>
        </tr></thead><tbody>`;

      filteredOrders.forEach(order => {
        const deliveredBtn = order.delivered ? `<span class="li-status delivered">已送货</span>` : `<button class="admin-btn deliver-btn" onclick="markDelivered(${order.id})">未送货</button>`;
        
        let settledBtn = '';
        if (order.settled) {
          settledBtn = `<span class="li-status settled">已结账</span>`;
        } else if (order.paymentSubmitted) {
          // 将待确认付款状态改为按钮
          settledBtn = `<button class="admin-btn confirm-payment-btn" onclick="confirmPaymentReceived(${order.id})">确认收款</button>`;
        } else {
          settledBtn = `<button class="admin-btn settle-btn" onclick="adminSettleOrder(${order.id})">未结账</button>`;
        }
        
        html += `<tr>
          <td>${order.id}</td>
          <td>${order.user}</td>
          <td>${order.item}</td>
          <td>$${order.price}</td>
          <td>${order.quantity}</td>
          <td>${order.time}</td>
          <td>${deliveredBtn}</td>
          <td>${settledBtn}</td>
          <td>
            <button class="admin-btn edit-btn" onclick="editOrder(${order.id})">编辑</button>
            <button class="admin-btn delete-btn" onclick="deleteOrder(${order.id})">删除</button>
          </td>
        </tr>`;
      });
      html += `</tbody></table>`;
      const boxUserDetail = document.getElementById("adminUserDetail");
      boxUserDetail.innerHTML = html;
      boxUserDetail.classList.remove("hidden");
    }

    // 显示指定用户订单详情
    function showAdminUserDetail(user, updateFilterBar) {
      if (!isAdminAccount) return;
      let userOrders = orders.filter(o => o.user === user);
      if (currentFilter === "delivered") userOrders = userOrders.filter(o => o.delivered);
      else if (currentFilter === "undelivered") userOrders = userOrders.filter(o => !o.delivered);

      userOrders = userOrders.slice();
      userOrders.sort((a, b) => {
        let valA = a[currentSort.key];
        let valB = b[currentSort.key];
        if (currentSort.key === "time") {
          valA = new Date(valA);
          valB = new Date(valB);
        }
        if (valA < valB) return currentSort.asc ? -1 : 1;
        if (valA > valB) return currentSort.asc ? 1 : -1;
        return 0;
      });

      const box = document.getElementById("adminUserDetail");
      if (userOrders.length === 0) {
        box.innerHTML = `<div style="text-align:center;margin:20px 0;">用户${user}暂无订单。</div>`;
        box.classList.remove("hidden");
        return;
      }

      let html = `<table class="admin-table">
        <thead><tr>
          <th onclick="toggleSort('id')" style="cursor:pointer;">订单ID ${sortArrow('id')}</th>
          <th onclick="toggleSort('item')" style="cursor:pointer;">商品 ${sortArrow('item')}</th>
          <th onclick="toggleSort('price')" style="cursor:pointer;">金额 ${sortArrow('price')}</th>
          <th>数量</th>
          <th onclick="toggleSort('time')" style="cursor:pointer;">下单时间 ${sortArrow('time')}</th>
          <th>送货状态</th>
          <th>结账状态</th>
          <th>操作</th>
        </tr></thead><tbody>`;

      userOrders.forEach(order => {
        const deliveredBtn = order.delivered ? `<span class="li-status delivered">已送货</span>` : `<button class="admin-btn deliver-btn" onclick="markDelivered(${order.id})">未送货</button>`;
        
        let settledBtn = '';
        if (order.settled) {
          settledBtn = `<span class="li-status settled">已结账</span>`;
        } else if (order.paymentSubmitted) {
          // 将待确认付款状态改为按钮
          settledBtn = `<button class="admin-btn confirm-payment-btn" onclick="confirmPaymentReceived(${order.id})">确认收款</button>`;
        } else {
          settledBtn = `<button class="admin-btn settle-btn" onclick="adminSettleOrder(${order.id})">未结账</button>`;
        }
        
        html += `<tr>
          <td>${order.id}</td>
          <td>${order.item}</td>
          <td>$${order.price}</td>
          <td>${order.quantity}</td>
          <td>${order.time}</td>
          <td>${deliveredBtn}</td>
          <td>${settledBtn}</td>
          <td>
            <button class="admin-btn edit-btn" onclick="editOrder(${order.id})">编辑</button>
            <button class="admin-btn delete-btn" onclick="deleteOrder(${order.id})">删除</button>
          </td>
        </tr>`;
      });
      html += `</tbody></table>`;
      box.innerHTML = html;
      box.classList.remove("hidden");

      if (updateFilterBar) renderFilterSortBar();
    }

    // 渲染筛选和排序栏
    function renderFilterSortBar() {
      if (!isAdminAccount) return;
      const container = document.getElementById("tableFilterBar");
      const filters = ['all', 'delivered', 'undelivered', 'settled', 'unsettled'];
      let html = `筛选订单：`;
      filters.forEach(f => {
        html += `<button onclick="changeFilter('${f}')" style="font-weight:${currentFilter === f ? '700' : 'normal'};">${f === 'all' ? '全部' : f === 'delivered' ? '已送货' : f === 'undelivered' ? '未送货' : f === 'settled' ? '已结账' : '未结账'}</button>`;
      });
      html += ` <button onclick="toggleSort(currentSort.key)" title="点击排序">排序：${currentSort.key} ${currentSort.asc ? '↑' : '↓'}</button>`;
      container.innerHTML = html;
    }

    // 改变筛选条件
    function changeFilter(filter) {
      currentFilter = filter;
      if (adminDetailUser === "__ALL__") showAdminAllOrdersTable();
      else showAdminUserDetail(adminDetailUser, false);
      renderFilterSortBar();
    }

    // 切换排序
    function toggleSort(key) {
      if (currentSort.key === key) currentSort.asc = !currentSort.asc;
      else {
        currentSort.key = key;
        currentSort.asc = true;
      }
      if (adminDetailUser === "__ALL__") showAdminAllOrdersTable();
      else showAdminUserDetail(adminDetailUser, false);
      renderFilterSortBar();
    }

    // 排序箭头显示
    function sortArrow(key) {
      if (currentSort.key !== key) return '';
      return currentSort.asc ? '↑' : '↓';
    }

    // 标记订单已送货
    function markDelivered(id) {
      let order = orders.find(o => o.id === id);
      if (!order) return;
      if (order.delivered) {
        alert('订单已标记为已送货。');
        return;
      }
      db.ref(`orders/${id}/delivered`).set(true);
      // 更新库存结账金额
      const invArr = getInventoryArray();
      const productIndex = invArr.findIndex(p => p.name === order.item);
      if (productIndex >= 0) {
        const product = invArr[productIndex];
        const newSettled = (product.settledAmount || 0) + order.price;
        const newUnsettled = (product.unsettledAmount || 0) - order.price;
        const newSold = (product.sold || 0) + order.quantity;
        db.ref(`inventory/${productIndex}`).update({
          settledAmount: newSettled,
          unsettledAmount: newUnsettled,
          sold: newSold
        });
      }
      showNotification(`订单 ${id} 标记为已送货`);
      if (adminDetailUser === "__ALL__") showAdminAllOrdersTable();
      else showAdminUserDetail(adminDetailUser, false);
    }

    // 编辑订单
    function editOrder(id) {
      let order = orders.find(o => o.id === id);
      if (!order) return;
      currentEditOrder = order;
      
      document.getElementById('editOrderPrice').value = order.price;
      document.getElementById('editOrderQuantity').value = order.quantity;
      document.getElementById('editOrderTip').textContent = "";
      document.getElementById('editOrderModal').classList.remove('hidden');
    }

    // 保存订单修改
    function saveOrderChanges() {
      if (!currentEditOrder) return;
      
      const newPrice = parseFloat(document.getElementById('editOrderPrice').value);
      const newQuantity = parseFloat(document.getElementById('editOrderQuantity').value);
      
      if (isNaN(newPrice) || newPrice < 0) {
        document.getElementById('editOrderTip').textContent = "请输入有效的价格";
        return;
      }
      
      if (isNaN(newQuantity) || newQuantity <= 0) {
        document.getElementById('editOrderTip').textContent = "请输入有效的数量";
        return;
      }
      
      // 计算价格和数量的变化
      const priceDiff = newPrice - currentEditOrder.price;
      const quantityDiff = newQuantity - currentEditOrder.quantity;
      
      // 更新订单
      db.ref(`orders/${currentEditOrder.id}`).update({
        price: newPrice,
        quantity: newQuantity
      });
      
      // 更新库存
      const invArr = getInventoryArray();
      const productIndex = invArr.findIndex(p => p.name === currentEditOrder.item);
      if (productIndex >= 0) {
        const product = invArr[productIndex];
        
        // 计算库存变化
        const stockChange = -quantityDiff; // 数量增加则库存减少
        const unsettledChange = priceDiff;
        
        db.ref(`inventory/${productIndex}`).update({
          remainingStock: product.remainingStock + stockChange,
          unsettledAmount: product.unsettledAmount + unsettledChange
        });
      }
      
      document.getElementById('editOrderModal').classList.add('hidden');
      showNotification(`订单 ${currentEditOrder.id} 已更新`);
      currentEditOrder = null;
    }

    // 删除订单
    function deleteOrder(id) {
      let order = orders.find(o => o.id === id);
      if (!order) return;
      customConfirm(`确认删除订单 ${id}（${order.user}的${order.item}）吗？`, ok => {
        if (!ok) return;
        db.ref(`orders/${id}`).remove();

        // 恢复库存和结账金额
        const invArr = getInventoryArray();
        const productIndex = invArr.findIndex(p => p.name === order.item);
        if (productIndex >= 0) {
          const product = invArr[productIndex];
          const newRemaining = (product.remainingStock || 0) + order.quantity;
          let updates = { remainingStock: newRemaining };
          if (order.delivered) {
            updates.settledAmount = (product.settledAmount || 0) - order.price;
            updates.sold = (product.sold || 0) - order.quantity;
          } else {
            updates.unsettledAmount = (product.unsettledAmount || 0) - order.price;
          }
          db.ref(`inventory/${productIndex}`).update(updates);
        }
        showNotification(`订单 ${id} 已删除`);
        if (adminDetailUser === "__ALL__") showAdminAllOrdersTable();
        else showAdminUserDetail(adminDetailUser, false);
      }, { type: 'warn' });
    }

    // 结账订单
    function checkoutOrder(id) {
      let order = orders.find(o => o.id === id);
      if (!order) return;
      if (!order.delivered) {
        alert("订单未送货，无法结账。");
        return;
      }
      // 结账即删除订单
      customConfirm(`确定结账并删除订单 ${id} 吗？`, ok => {
        if (!ok) return;
        db.ref(`orders/${id}`).remove();
        showNotification(`订单 ${id} 已结账并删除`);
        if (adminDetailUser === "__ALL__") showAdminAllOrdersTable();
        else showAdminUserDetail(adminDetailUser, false);
      });
    }

    // 结账指定用户所有订单
    function checkoutUser(user) {
      const userOrders = orders.filter(o => o.user === user && o.delivered);
      if (userOrders.length === 0) {
        alert(`用户${user}暂无已送货订单可结账。`);
        return;
      }
      customConfirm(`确定结账并删除用户 ${user} 所有已送货订单吗？`, ok => {
        if (!ok) return;
        userOrders.forEach(o => {
          db.ref(`orders/${o.id}`).remove();
        });
        showNotification(`用户 ${user} 已送货订单全部结账并删除`);
        if (adminDetailUser === "__ALL__") showAdminAllOrdersTable();
        else showAdminUserDetail(adminDetailUser, false);
      });
    }

    // 结账单个订单
    function settleOrder(id) {
      const order = orders.find(o => o.id === id);
      if (!order) return;
      
      currentSettleOrder = order;
      currentSettleAll = false;
      
      document.getElementById('settleAmount').textContent = `$${order.price.toFixed(2)}`;
      document.getElementById('settleAmountText').textContent = `$${order.price.toFixed(2)}`;
      document.getElementById('settleModal').style.display = 'block';
    }
    
    // 结账所有订单
    function settleAllOrders() {
      const userOrders = orders.filter(o => o.user === currentUser && !o.settled);
      if (userOrders.length === 0) {
        customAlert("您没有未结账的订单");
        return;
      }
      
      const totalAmount = userOrders.reduce((sum, o) => sum + o.price, 0);
      
      currentSettleOrder = null;
      currentSettleAll = true;
      
      document.getElementById('settleAmount').textContent = `$${totalAmount.toFixed(2)}`;
      document.getElementById('settleAmountText').textContent = `$${totalAmount.toFixed(2)}`;
      document.getElementById('settleModal').style.display = 'block';
    }
    
    // 管理员结账订单
    function adminSettleOrder(id) {
      const order = orders.find(o => o.id === id);
      if (!order) return;
      
      if (!order.delivered) {
        customAlert("请先标记订单为已送货");
        return;
      }
      
      db.ref(`orders/${id}`).update({
        settled: true,
        paymentSubmitted: false
      });
      
      // 更新库存结账金额
      const invArr = getInventoryArray();
      const productIndex = invArr.findIndex(p => p.name === order.item);
      if (productIndex >= 0) {
        const product = invArr[productIndex];
        const newSettled = (product.settledAmount || 0) + order.price;
        const newUnsettled = (product.unsettledAmount || 0) - order.price;
        db.ref(`inventory/${productIndex}`).update({
          settledAmount: newSettled,
          unsettledAmount: newUnsettled
        });
      }
      
      showNotification(`订单 ${id} 已确认结账`);
      if (adminDetailUser === "__ALL__") showAdminAllOrdersTable();
      else showAdminUserDetail(adminDetailUser, false);
    }
    
    // 管理员确认收款
    function confirmPaymentReceived(id) {
      const order = orders.find(o => o.id === id);
      if (!order) return;
      
      customConfirm(`确认订单 ${id}（${order.user}的${order.item}）的款项已经收到？`, ok => {
        if (!ok) return;
        
        // 更新订单状态
        db.ref(`orders/${id}`).update({
          settled: true,
          paymentSubmitted: false
        });
        
        // 更新库存金额
        const invArr = getInventoryArray();
        const productIndex = invArr.findIndex(p => p.name === order.item);
        if (productIndex >= 0) {
          const product = invArr[productIndex];
          const newSettled = (product.settledAmount || 0) + order.price;
          const newUnsettled = (product.unsettledAmount || 0) - order.price;
          db.ref(`inventory/${productIndex}`).update({
            settledAmount: newSettled,
            unsettledAmount: newUnsettled
          });
        }
        
        showNotification(`订单 ${id} 的款项已确认`);
        if (adminDetailUser === "__ALL__") showAdminAllOrdersTable();
        else showAdminUserDetail(adminDetailUser, false);
      });
    }
    
    // 确认付款
    function confirmPayment() {
      document.getElementById('settleModal').style.display = 'none';
      
      if (currentSettleAll) {
        // 结账所有未结账订单
        const userOrders = orders.filter(o => o.user === currentUser && !o.settled);
        userOrders.forEach(order => {
          db.ref(`orders/${order.id}/paymentSubmitted`).set(true);
        });
        
        showNotification(`您的 ${userOrders.length} 笔订单已提交付款申请，等待管理员确认`);
      } else if (currentSettleOrder) {
        // 结账单个订单
        db.ref(`orders/${currentSettleOrder.id}/paymentSubmitted`).set(true);
        
        showNotification(`订单 ${currentSettleOrder.id} 已提交付款申请，等待管理员确认`);
      }
      
      currentSettleOrder = null;
      currentSettleAll = false;
    }
    
    // 关闭结账弹窗
    function closeSettleModal() {
      document.getElementById('settleModal').style.display = 'none';
      currentSettleOrder = null;
      currentSettleAll = false;
    }

    // 弹窗封装
    function customConfirm(msg, callback, opts) {
      let box = document.getElementById('customModalBox');
      let modal = document.getElementById('customModal');
      let type = opts && opts.type || 'confirm', input = opts && opts.input;
      box.innerHTML = `
        <div style="margin-bottom:20px;font-size:17px;color:#223;font-weight:700;white-space:pre-wrap;">${msg}</div>
        ${input ? `<input id="customInput" type="${input === 'number' ? 'number' : 'text'}" style="font-size:17px;margin-bottom:16px;" value="${opts.value || ''}" />` : ""}
        <div class="custom-modal-btn-row">
          <button class="custom-modal-btn custom-confirm">${type === 'warn' ? '确定' : '确定'}</button>
          <button class="custom-modal-btn custom-cancel">取消</button>
        </div>
        <div style="height:4px"></div>
      `;
      modal.classList.remove('hidden');
      box.querySelector('.custom-cancel').onclick = () => {
        modal.classList.add('hidden');
        callback(false);
      };
      box.querySelector('.custom-confirm').onclick = () => {
        modal.classList.add('hidden');
        if (input) callback(document.getElementById('customInput').value);
        else callback(true);
      };
      setTimeout(() => {
        let inp = document.getElementById('customInput');
        if (inp) inp.focus();
      }, 100);
    }

    function customPrompt(msg, callback, opts) {
      let box = document.getElementById('customModalBox');
      let modal = document.getElementById('customModal');
      let inputType = (opts && opts.input) || 'text';
      box.innerHTML = `
        <div style="margin-bottom:20px;font-size:17px;color:#223;font-weight:700;white-space:pre-wrap;">${msg}</div>
        <input id="customInput" type="${inputType}" style="font-size:17px;margin-bottom:16px;" value="${opts?.value || ''}" />
        <div class="custom-modal-btn-row">
          <button class="custom-modal-btn custom-confirm">确定</button>
          <button class="custom-modal-btn custom-cancel">取消</button>
        </div>
        <div style="height:4px"></div>
      `;
      modal.classList.remove('hidden');
      box.querySelector('.custom-cancel').onclick = () => {
        modal.classList.add('hidden');
        callback(false);
      };
      box.querySelector('.custom-confirm').onclick = () => {
        modal.classList.add('hidden');
        callback(document.getElementById('customInput').value);
      };
      setTimeout(() => {
        document.getElementById('customInput').focus();
      }, 100);
    }

    function customAlert(msg, type, cb) {
      let box = document.getElementById('customModalBox');
      let modal = document.getElementById('customModal');
      box.innerHTML = `
        <div style="margin-bottom:16px;font-size:17px;font-weight:700;color:${type == 'warn' ? '#bb2222' : '#2d7df0'};white-space:pre-wrap;">${msg}</div>
        <button class="custom-modal-btn custom-confirm">确定</button>
        <div style="height:3px"></div>
      `;
      modal.classList.remove('hidden');
      box.querySelector('.custom-confirm').onclick = () => {
        modal.classList.add('hidden');
        if (cb) cb();
      };
    }

    // 通知提示
    function showNotification(msg) {
      const box = document.getElementById("adminNotification");
      box.textContent = msg;
      box.style.display = "block";
      clearTimeout(box._timeout);
      box._timeout = setTimeout(() => {
        box.style.display = "none";
      }, 3500);
    }

    // 登录注册相关
    function hideLoginModal() {
      document.getElementById('loginModal').classList.add('hidden');
    }
    function hideRegisterModal() {
      document.getElementById('registerModal').classList.add('hidden');
    }
    
    // 修改密码
    function changePassword() {
      const oldPwd = document.getElementById('oldPwd').value;
      const newPwd = document.getElementById('newPwd').value;
      const confirmNewPwd = document.getElementById('confirmNewPwd').value;
      const tip = document.getElementById('changePwdTip');
      tip.textContent = "";
      
      if (!oldPwd) {
        tip.textContent = "请输入旧密码";
        return;
      }
      if (!newPwd || newPwd.length < 6) {
        tip.textContent = "新密码至少需要6位";
        return;
      }
      if (newPwd !== confirmNewPwd) {
        tip.textContent = "两次输入的新密码不一致";
        return;
      }
      
      const user = currentUser;
      
      // 管理员特殊处理
      if (user === "余歌") {
        if (oldPwd !== "ygrdsj") {
          tip.textContent = "旧密码错误";
          return;
        }
        
        // 更新管理员密码
        db.ref('users/余歌').set({ 
          name: "余歌", 
          password: newPwd, 
          created: Date.now() 
        }, (error) => {
          if (error) {
            tip.textContent = "修改失败：" + error.message;
          } else {
            tip.textContent = "管理员密码修改成功！";
            tip.className = "tip success";
            setTimeout(() => {
              document.getElementById('changePwdModal').classList.add('hidden');
            }, 1500);
          }
        });
      } else {
        // 普通用户处理
        db.ref('users/' + user).once('value').then(snapshot => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            if (userData.password === oldPwd) {
              // 更新密码
              db.ref('users/' + user).update({ 
                password: newPwd 
              }, (error) => {
                if (error) {
                  tip.textContent = "修改失败：" + error.message;
                } else {
                  tip.textContent = "密码修改成功！";
                  tip.className = "tip success";
                  localStorage.setItem("userPwd", newPwd);
                  setTimeout(() => {
                    document.getElementById('changePwdModal').classList.add('hidden');
                  }, 1500);
                }
              });
            } else {
              tip.textContent = "旧密码错误";
            }
          } else {
            tip.textContent = "用户数据不存在";
          }
        });
      }
    }

    function doLogin() {
      const name = document.getElementById('loginName').value.trim();
      const pwd = document.getElementById('loginPwd').value;
      const tip = document.getElementById('loginModalTip');
      if (!/^[\u4e00-\u9fa5]{2,6}$/.test(name)) {
        tip.textContent = "账号需2-6个中文汉字。";
        return;
      }
      if (!pwd) {
        tip.textContent = "请输入密码。";
        return;
      }
      db.ref('users/' + name).once('value').then(snapshot => {
        if (snapshot.exists()) {
          const user = snapshot.val();
          if (name === "余歌") {
            if (pwd === "ygrdsj") {
              loginSuccess(name, pwd);
              hideLoginModal();
            } else {
              tip.textContent = "管理员密码错误！";
            }
          } else if (user.password === pwd) {
            loginSuccess(name, pwd);
            hideLoginModal();
          } else {
            tip.textContent = "密码错误！";
          }
        } else {
          tip.textContent = "该账号不存在，请先注册。";
        }
      });
    }

    function doRegister() {
      const name = document.getElementById('registerName').value.trim();
      const pwd = document.getElementById('registerPwd').value;
      const tip = document.getElementById('registerModalTip');
      if (!/^[\u4e00-\u9fa5]{2,6}$/.test(name)) {
        tip.textContent = "账号需2-6个中文汉字。";
        return;
      }
      if (!pwd || pwd.length < 6) {
        tip.textContent = "密码至少6位。";
        return;
      }
      if (name === "余歌" && pwd !== "ygrdsj") {
        tip.textContent = "管理员账号请用正确密码注册。";
        return;
      }
      db.ref('users/' + name).once('value').then(snapshot => {
        if (snapshot.exists()) {
          tip.textContent = "该账号已存在，请直接登录。";
        } else {
          db.ref('users/' + name).set({ name: name, password: pwd, created: Date.now() });
          loginSuccess(name, pwd);
          hideRegisterModal();
        }
      });
    }

    function loginSuccess(name, pwd) {
      currentUser = name;
      localStorage.setItem("userName", name);
      localStorage.setItem("userPwd", pwd);
      updateUIByLoginState();
      updateUserSummary();
      listenInventory();
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem("userName");
      localStorage.removeItem("userPwd");
      adminDetailUser = "__ALL__";
      currentFilter = "all";
      currentSort = { key: "id", asc: true };
      if (inventoryListenerActive) {
        db.ref('inventory').off('value');
        inventoryListenerActive = false;
      }
      updateUIByLoginState();
      updateUserSummary();
    }

    function updateUIByLoginState() {
      if (currentUser) {
        document.getElementById('userInfo').style.display = '';
        document.getElementById('userInfo').textContent = "欢迎，" + currentUser;
        document.getElementById('logoutBtn').style.display = '';
        document.getElementById('changePwdBtn').style.display = '';
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('registerBtn').style.display = 'none';
        document.getElementById('loginCenter').style.display = 'none';
        document.getElementById('guestProducts').classList.add('hidden');
        document.getElementById('loginTip').style.display = 'none';
        document.getElementById('systemPanel').style.display = 'block';

        isAdminAccount = (currentUser === "余歌");
        if (isAdminAccount) {
          document.getElementById('adminPanelWrap').classList.remove('hidden');
          initInventory();
          renderAdminUserList();
          if(adminDetailUser === "__ALL__") showAdminAllOrdersTable();
          else showAdminUserDetail(adminDetailUser, false);
          renderFilterSortBar();
        } else {
          document.getElementById('adminPanelWrap').classList.add('hidden');
          document.getElementById('adminUserDetail').classList.add('hidden');
        }
      } else {
        document.getElementById('userInfo').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'none';
        document.getElementById('changePwdBtn').style.display = 'none';
        document.getElementById('loginBtn').style.display = '';
        document.getElementById('registerBtn').style.display = '';
        document.getElementById('loginCenter').style.display = 'flex';
        document.getElementById('guestProducts').classList.remove('hidden');
        document.getElementById('loginTip').style.display = '';
        document.getElementById('loginTip').textContent = "请登录后才能下单和查看消费记录。";
        document.getElementById('systemPanel').style.display = 'none';
        document.getElementById('adminPanelWrap').classList.add('hidden');
        document.getElementById('adminUserDetail').classList.add('hidden');
        isAdminAccount = false;
      }
    }

    // 页面加载时自动登录
    window.onload = function () {
      const name = localStorage.getItem("userName");
      const pwd = localStorage.getItem("userPwd");
      if (name && pwd && /^[\u4e00-\u9fa5]{2,6}$/.test(name)) {
        db.ref('users/' + name).once('value').then(snapshot => {
          if (snapshot.exists()) {
            const user = snapshot.val();
            if ((name === "余歌" && pwd === "ygrdsj") || (user.password === pwd)) {
              loginSuccess(name, pwd);
            } else {
              logout();
            }
          } else {
            logout();
          }
        });
      } else {
        updateUIByLoginState();
        initInventory(); // 初始化库存和访客展示
      }
    }

    // 弹窗Esc和点击背景关闭
    window.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        hideLoginModal();
        hideRegisterModal();
        document.getElementById('changePwdModal').classList.add('hidden');
        document.getElementById('customModal').classList.add('hidden');
        document.getElementById('addProductModal').classList.add('hidden');
        document.getElementById('editProductModal').classList.add('hidden');
        document.getElementById('editOrderModal').classList.add('hidden');
        document.getElementById('adminPopup').style.display = 'none';
        closeSettleModal();
      }
    });

    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function (e) {
        if (e.target === modal) {
          hideLoginModal();
          hideRegisterModal();
          document.getElementById('changePwdModal').classList.add('hidden');
          document.getElementById('customModal').classList.add('hidden');
          document.getElementById('addProductModal').classList.add('hidden');
          document.getElementById('editProductModal').classList.add('hidden');
          document.getElementById('editOrderModal').classList.add('hidden');
          closeSettleModal();
        }
      });
    });

    // 添加商品弹窗
    function showAddProductModal() {
      document.getElementById('addProductTip').textContent = "";
      document.getElementById('productName').value = "";
      document.getElementById('productPrice').value = "";
      document.getElementById('productStock').value = "";
      document.getElementById('productPerOrder').value = "1";
      document.getElementById('addProductModal').classList.remove('hidden');
    }

    // 添加商品
    function addProduct() {
      const name = document.getElementById('productName').value.trim();
      const price = parseFloat(document.getElementById('productPrice').value);
      const stock = parseInt(document.getElementById('productStock').value);
      const perOrder = parseFloat(document.getElementById('productPerOrder').value);
      const tip = document.getElementById('addProductTip');
      tip.textContent = "";
      if (!name) {
        tip.textContent = "商品名称不能为空";
        return;
      }
      if (isNaN(price) || price <= 0) {
        tip.textContent = "请输入有效的单价";
        return;
      }
      if (isNaN(stock) || stock < 0) {
        tip.textContent = "请输入有效的库存数量";
        return;
      }
      if (isNaN(perOrder) || perOrder <= 0) {
        tip.textContent = "请输入有效的每次下单数量";
        return;
      }

      const invArr = getInventoryArray();
      if (invArr.find(p => p.name === name)) {
        tip.textContent = "该商品名称已存在";
        return;
      }
      invArr.push({
        name: name,
        price: price,
        totalStock: stock,
        remainingStock: stock,
        sold: 0,
        settledAmount: 0,
        unsettledAmount: 0,
        perOrder: perOrder
      });
      db.ref('inventory').set(invArr);
      document.getElementById('addProductModal').classList.add('hidden');
      showNotification(`商品 ${name} 已添加`);
   }
  </script>
</body>
</html>
